-- KiwiSense Function Source - Updated for Solara Compatibility
-- This contains all the core functions that the library will use

local KiwiSense = {}

-- Color management functions
function KiwiSense.CreateColor(r, g, b, a)
    a = a or 1
    return Color3.new(r/255, g/255, b/255), a
end

function KiwiSense.FromHex(hex)
    hex = hex:gsub("#", "")
    local r = tonumber(hex:sub(1,2), 16)
    local g = tonumber(hex:sub(3,4), 16) 
    local b = tonumber(hex:sub(5,6), 16)
    return Color3.new(r/255, g/255, b/255)
end

function KiwiSense.ToHex(color3)
    local r = math.floor(color3.R * 255)
    local g = math.floor(color3.G * 255)
    local b = math.floor(color3.B * 255)
    return string.format("#%02X%02X%02X", r, g, b)
end

-- Drawing functions
function KiwiSense.CreateDrawing(type)
    local drawing = Drawing.new(type)
    
    -- Add safety wrappers
    local originalRemove = drawing.Remove
    drawing.Remove = function(self)
        pcall(originalRemove, self)
    end
    
    return drawing
end

-- Input handling
function KiwiSense.IsKeyPressed(keycode)
    return UserInputService:IsKeyDown(keycode)
end

-- UI Creation helpers
function KiwiSense.CreateWindow(config)
    config = config or {}
    
    local window = {
        Title = config.Title or "KiwiSense",
        Size = config.Size or UDim2.new(0, 500, 0, 400),
        Position = config.Position or UDim2.new(0.5, -250, 0.5, -200),
        Tabs = {},
        CurrentTab = nil
    }
    
    -- Create main screenGui
    window.ScreenGui = Instance.new("ScreenGui")
    window.ScreenGui.Name = "KiwiSense_" .. tick()
    window.ScreenGui.Parent = game:GetService("CoreGui")
    window.ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    -- Main frame
    window.Main = Instance.new("Frame")
    window.Main.Name = "Main"
    window.Main.Parent = window.ScreenGui
    window.Main.Size = window.Size
    window.Main.Position = window.Position
    window.Main.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    window.Main.BorderSizePixel = 0
    
    -- Title bar
    window.TitleBar = Instance.new("Frame")
    window.TitleBar.Name = "TitleBar"
    window.TitleBar.Parent = window.Main
    window.TitleBar.Size = UDim2.new(1, 0, 0, 30)
    window.TitleBar.Position = UDim2.new(0, 0, 0, 0)
    window.TitleBar.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
    window.TitleBar.BorderSizePixel = 0
    
    -- Title label
    window.TitleLabel = Instance.new("TextLabel")
    window.TitleLabel.Name = "TitleLabel"
    window.TitleLabel.Parent = window.TitleBar
    window.TitleLabel.Size = UDim2.new(1, -60, 1, 0)
    window.TitleLabel.Position = UDim2.new(0, 10, 0, 0)
    window.TitleLabel.BackgroundTransparency = 1
    window.TitleLabel.Text = window.Title
    window.TitleLabel.TextColor3 = Color3.new(1, 1, 1)
    window.TitleLabel.TextSize = 14
    window.TitleLabel.Font = Enum.Font.SourceSans
    window.TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    -- Close button
    window.CloseButton = Instance.new("TextButton")
    window.CloseButton.Name = "CloseButton"
    window.CloseButton.Parent = window.TitleBar
    window.CloseButton.Size = UDim2.new(0, 30, 1, 0)
    window.CloseButton.Position = UDim2.new(1, -30, 0, 0)
    window.CloseButton.BackgroundTransparency = 1
    window.CloseButton.Text = "X"
    window.CloseButton.TextColor3 = Color3.new(1, 0.5, 0.5)
    window.CloseButton.TextSize = 14
    window.CloseButton.Font = Enum.Font.SourceSans
    
    -- Content area
    window.Content = Instance.new("Frame")
    window.Content.Name = "Content"
    window.Content.Parent = window.Main
    window.Content.Size = UDim2.new(1, 0, 1, -30)
    window.Content.Position = UDim2.new(0, 0, 0, 30)
    window.Content.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    window.Content.BorderSizePixel = 0
    
    -- Tab buttons container
    window.TabButtons = Instance.new("Frame")
    window.TabButtons.Name = "TabButtons"
    window.TabButtons.Parent = window.Content
    window.TabButtons.Size = UDim2.new(0, 150, 1, 0)
    window.TabButtons.Position = UDim2.new(0, 0, 0, 0)
    window.TabButtons.BackgroundColor3 = Color3.new(0.05, 0.05, 0.05)
    window.TabButtons.BorderSizePixel = 0
    
    -- Tab content area
    window.TabContent = Instance.new("ScrollingFrame")
    window.TabContent.Name = "TabContent"
    window.TabContent.Parent = window.Content
    window.TabContent.Size = UDim2.new(1, -150, 1, 0)
    window.TabContent.Position = UDim2.new(0, 150, 0, 0)
    window.TabContent.BackgroundTransparency = 1
    window.TabContent.BorderSizePixel = 0
    window.TabContent.ScrollBarThickness = 8
    window.TabContent.CanvasSize = UDim2.new(0, 0, 0, 0)
    
    -- Add tab creation function
    function window:AddTab(name)
        local tab = {
            Name = name,
            Elements = {},
            Index = #self.Tabs + 1
        }
        
        -- Create tab button
        local tabButton = Instance.new("TextButton")
        tabButton.Name = "Tab_" .. name
        tabButton.Parent = self.TabButtons
        tabButton.Size = UDim2.new(1, -10, 0, 30)
        tabButton.Position = UDim2.new(0, 5, 0, tab.Index * 35 - 35)
        tabButton.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
        tabButton.BorderSizePixel = 0
        tabButton.Text = name
        tabButton.TextColor3 = Color3.new(0.8, 0.8, 0.8)
        tabButton.TextSize = 12
        tabButton.Font = Enum.Font.SourceSans
        
        -- Create tab content
        local tabContent = Instance.new("Frame")
        tabContent.Name = "TabContent_" .. name
        tabContent.Parent = self.TabContent
        tabContent.Size = UDim2.new(1, -10, 1, 0)
        tabContent.Position = UDim2.new(0, 5, 0, 0)
        tabContent.BackgroundTransparency = 1
        tabContent.BorderSizePixel = 0
        tabContent.Visible = (tab.Index == 1)
        
        -- Tab switching
        tabButton.MouseButton1Click:Connect(function()
            -- Hide all tabs
            for _, otherTab in pairs(self.Tabs) do
                if otherTab.Content then
                    otherTab.Content.Visible = false
                end
            end
            
            -- Show selected tab
            tabContent.Visible = true
            self.CurrentTab = tab
            
            -- Update button colors
            for _, child in pairs(self.TabButtons:GetChildren()) do
                if child:IsA("TextButton") then
                    child.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
                    child.TextColor3 = Color3.new(0.8, 0.8, 0.8)
                end
            end
            tabButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
            tabButton.TextColor3 = Color3.new(1, 1, 1)
        end)
        
        tab.Button = tabButton
        tab.Content = tabContent
        
        table.insert(self.Tabs, tab)
        
        -- Set as current tab if first
        if tab.Index == 1 then
            self.CurrentTab = tab
            tabButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
            tabButton.TextColor3 = Color3.new(1, 1, 1)
        end
        
        return tab
    end
    
    -- Add element creation functions
    function window:AddButton(text, callback)
        if not self.CurrentTab then return end
        
        local button = Instance.new("TextButton")
        button.Name = "Button_" .. tick()
        button.Parent = self.CurrentTab.Content
        button.Size = UDim2.new(1, 0, 0, 25)
        button.Position = UDim2.new(0, 0, 0, #self.CurrentTab.Elements * 30)
        button.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
        button.BorderSizePixel = 0
        button.Text = text
        button.TextColor3 = Color3.new(1, 1, 1)
        button.TextSize = 12
        button.Font = Enum.Font.SourceSans
        
        button.MouseButton1Click:Connect(callback)
        
        table.insert(self.CurrentTab.Elements, button)
        self:_UpdateTabContentSize()
        
        return button
    end
    
    function window:AddToggle(text, default, callback)
        if not self.CurrentTab then return end
        
        local frame = Instance.new("Frame")
        frame.Name = "Toggle_" .. tick()
        frame.Parent = self.CurrentTab.Content
        frame.Size = UDim2.new(1, 0, 0, 25)
        frame.Position = UDim2.new(0, 0, 0, #self.CurrentTab.Elements * 30)
        frame.BackgroundTransparency = 1
        frame.BorderSizePixel = 0
        
        local button = Instance.new("TextButton")
        button.Name = "Button"
        button.Parent = frame
        button.Size = UDim2.new(0, 20, 0, 20)
        button.Position = UDim2.new(0, 0, 0, 2.5)
        button.BackgroundColor3 = default and Color3.new(0.2, 0.8, 0.2) or Color3.new(0.8, 0.2, 0.2)
        button.BorderSizePixel = 0
        button.Text = ""
        button.Font = Enum.Font.SourceSans
        
        local label = Instance.new("TextLabel")
        label.Name = "Label"
        label.Parent = frame
        label.Size = UDim2.new(1, -25, 1, 0)
        label.Position = UDim2.new(0, 25, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Color3.new(1, 1, 1)
        label.TextSize = 12
        label.Font = Enum.Font.SourceSans
        label.TextXAlignment = Enum.TextXAlignment.Left
        
        local state = default or false
        button.MouseButton1Click:Connect(function()
            state = not state
            button.BackgroundColor3 = state and Color3.new(0.2, 0.8, 0.2) or Color3.new(0.8, 0.2, 0.2)
            callback(state)
        end)
        
        table.insert(self.CurrentTab.Elements, frame)
        self:_UpdateTabContentSize()
        
        return frame
    end
    
    function window:AddSlider(text, min, max, default, callback)
        if not self.CurrentTab then return end
        
        local frame = Instance.new("Frame")
        frame.Name = "Slider_" .. tick()
        frame.Parent = self.CurrentTab.Content
        frame.Size = UDim2.new(1, 0, 0, 40)
        frame.Position = UDim2.new(0, 0, 0, #self.CurrentTab.Elements * 30)
        frame.BackgroundTransparency = 1
        frame.BorderSizePixel = 0
        
        local label = Instance.new("TextLabel")
        label.Name = "Label"
        label.Parent = frame
        label.Size = UDim2.new(1, 0, 0, 15)
        label.Position = UDim2.new(0, 0, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = text .. ": " .. default
        label.TextColor3 = Color3.new(1, 1, 1)
        label.TextSize = 12
        label.Font = Enum.Font.SourceSans
        label.TextXAlignment = Enum.TextXAlignment.Left
        
        local slider = Instance.new("TextButton")
        slider.Name = "Slider"
        slider.Parent = frame
        slider.Size = UDim2.new(1, 0, 0, 10)
        slider.Position = UDim2.new(0, 0, 0, 25)
        slider.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
        slider.BorderSizePixel = 0
        slider.Text = ""
        slider.Font = Enum.Font.SourceSans
        
        local fill = Instance.new("Frame")
        fill.Name = "Fill"
        fill.Parent = slider
        fill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
        fill.Position = UDim2.new(0, 0, 0, 0)
        fill.BackgroundColor3 = Color3.new(0.2, 0.6, 1)
        fill.BorderSizePixel = 0
        
        local value = default
        local dragging = false
        
        slider.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local relativeX = (input.Position.X - slider.AbsolutePosition.X) / slider.AbsoluteSize.X
                relativeX = math.max(0, math.min(1, relativeX))
                value = min + (max - min) * relativeX
                fill.Size = UDim2.new(relativeX, 0, 1, 0)
                label.Text = text .. ": " .. math.floor(value)
                callback(value)
            end
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        table.insert(self.CurrentTab.Elements, frame)
        self:_UpdateTabContentSize()
        
        return frame
    end
    
    function window:_UpdateTabContentSize()
        local totalHeight = 0
        for _, element in pairs(self.CurrentTab.Elements) do
            totalHeight = totalHeight + element.Size.Y.Offset + 5
        end
        self.TabContent.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
    end
    
    -- Window dragging
    local dragging = false
    local dragStart = nil
    local startPos = nil
    
    window.TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = window.Main.Position
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            window.Main.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    -- Close functionality
    window.CloseButton.MouseButton1Click:Connect(function()
        window.ScreenGui:Destroy()
        window = nil
    end)
    
    return window
end

-- ESP Functions
function KiwiSense.CreateESP(config)
    config = config or {}
    
    local esp = {
        Enabled = config.Enabled or false,
        ShowBoxes = config.ShowBoxes ~= false,
        ShowNames = config.ShowNames ~= false,
        ShowHealth = config.ShowHealth ~= false,
        ShowDistance = config.ShowDistance ~= false,
        BoxColor = config.BoxColor or Color3.new(1, 0, 0),
        TextColor = config.TextColor or Color3.new(1, 1, 1),
        MaxDistance = config.MaxDistance or 500,
        Drawings = {}
    }
    
    function esp:Update()
        -- Clear old drawings
        for _, drawing in pairs(self.Drawings) do
            if drawing.Remove then
                drawing:Remove()
            end
        end
        self.Drawings = {}
        
        if not self.Enabled then return end
        
        local localPlayer = game.Players.LocalPlayer
        if not localPlayer or not localPlayer.Character or not localPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
        
        local localPos = localPlayer.Character.HumanoidRootPart.Position
        
        for _, player in pairs(game.Players:GetPlayers()) do
            if player ~= localPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local character = player.Character
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                local rootPart = character.HumanoidRootPart
                
                local distance = (localPos - rootPart.Position).Magnitude
                if distance <= self.MaxDistance then
                    local onScreen, screenPos = workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position)
                    
                    if onScreen then
                        local espData = {}
                        
                        -- Box
                        if self.ShowBoxes then
                            local size = workspace.CurrentCamera:ViewportPointToWorldRay(screenPos.X, screenPos.Y)
                            local top = workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position + Vector3.new(0, 3, 0))
                            local bottom = workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position - Vector3.new(0, 3, 0))
                            
                            espData.Box = KiwiSense.CreateDrawing("Square")
                            espData.Box.Size = Vector2.new(math.abs(top.Y - bottom.Y), math.abs(top.Y - bottom.Y) * 2)
                            espData.Box.Position = Vector2.new(screenPos.X - espData.Box.Size.X/2, screenPos.Y - espData.Box.Size.Y/2)
                            espData.Box.Color = self.BoxColor
                            espData.Box.Thickness = 1
                            espData.Box.Filled = false
                            espData.Box.Visible = true
                            
                            table.insert(self.Drawings, espData.Box)
                        end
                        
                        -- Name
                        if self.ShowNames then
                            espData.Name = KiwiSense.CreateDrawing("Text")
                            espData.Name.Position = Vector2.new(screenPos.X, screenPos.Y - 20)
                            espData.Name.Text = player.Name
                            espData.Name.Color = self.TextColor
                            espData.Name.Size = 12
                            espData.Name.Font = 2
                            espData.Name.Center = true
                            espData.Name.Visible = true
                            
                            table.insert(self.Drawings, espData.Name)
                        end
                        
                        -- Health
                        if self.ShowHealth and humanoid then
                            espData.Health = KiwiSense.CreateDrawing("Text")
                            espData.Health.Position = Vector2.new(screenPos.X, screenPos.Y + 20)
                            espData.Health.Text = "HP: " .. math.floor(humanoid.Health)
                            espData.Health.Color = humanoid.Health > 50 and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
                            espData.Health.Size = 12
                            espData.Health.Font = 2
                            espData.Health.Center = true
                            espData.Health.Visible = true
                            
                            table.insert(self.Drawings, espData.Health)
                        end
                        
                        -- Distance
                        if self.ShowDistance then
                            espData.Distance = KiwiSense.CreateDrawing("Text")
                            espData.Distance.Position = Vector2.new(screenPos.X, screenPos.Y + 35)
                            espData.Distance.Text = math.floor(distance) .. "m"
                            espData.Distance.Color = Color3.new(1, 1, 0)
                            espData.Distance.Size = 12
                            espData.Distance.Font = 2
                            espData.Distance.Center = true
                            espData.Distance.Visible = true
                            
                            table.insert(self.Drawings, espData.Distance)
                        end
                    end
                end
            end
        end
    end
    
    function esp:Destroy()
        for _, drawing in pairs(self.Drawings) do
            if drawing.Remove then
                drawing:Remove()
            end
        end
        self.Drawings = {}
    end
    
    -- Auto-update loop
    game:GetService("RunService").RenderStepped:Connect(function()
        esp:Update()
    end)
    
    return esp
end

-- Return the functions
return KiwiSense
